<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      position: relative;
    }
    .background-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url("/images/background.png");
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.2;
      z-index: -1;
      pointer-events: none;
    }
    .sidebar {
      width: 250px;
      background: #f4f4f4;
      border-right: 1px solid #ccc;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .profile-photo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .profile-name {
      font-size: 25px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .profile-info {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .profile-info span {
      font-weight: normal;
    }
    .weekly-btn {
      margin-top: 20px;
      display: inline-block;
      min-width: 250px;
      padding: 10px;
      font-size: 18px;
      cursor: pointer;
    }
    .main {
      flex-grow: 1;
      padding: 20px;
      overflow-x: auto;
      overflow-y: auto;
    }
    .department-section h3 {
      font-size: 24px;
      margin-bottom: 14px;
    }
    .department-list {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
    }
    .department-button {
      width: 180px;
      height: 180px;
      border: 5px solid #ccc;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      font-size: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .department-button img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    .employee-entry {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .employee-entry img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
    }
    .employee-entry .full {
      font-weight: bold;
      font-size: 16px;
    }
    table {
      border: 2px solid #888;
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      table-layout: auto;
    }
    th, td {
      border: 3px solid #888;
      padding: 4px;
      font-size: 25px;
      min-width: 30px; 
      height: 36px;
      text-align: center;
      vertical-align: middle;
      word-break: keep-all;
      white-space: normal;
      line-height: 1.2;
    }
    th {
      background-color: #d0e9c6;
    }
    td span {
      display: block;
      margin-bottom: 5px;
    }
    .department-button.active {
      transform: scale(1.1);
      border-color: #007BFF;
      background-color: #e6f0ff;
      opacity: 1;
    }
    .department-button.inactive {
      opacity: 0.4;
    }
        
    td[data-color="primary"]   { background-color: green;  color: white;  }
    td[data-color="secondary"] { background-color: yellow; color: black;  }
    td[data-color="other"]     { background-color: lightgray; color: black; }

    .hours-display {
      font-weight: bold;
      font-size: 25px;
      margin-top: 30px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="background-layer"></div>

  <div class="sidebar">
    <img id="profile-photo" class="profile-photo" src="/images/default.jpg" alt="My Photo">
    <div class="profile-name" id="profile-name">--</div>
    <div class="profile-info">Age: <span id="profile-age">--</span></div>
    <div class="profile-info">Primary Job: <span id="profile-primary">--</span></div>
    <div class="profile-info">Secondary Job: <span id="profile-secondary">--</span></div>
    <button class="weekly-btn" onclick="showMySchedule()">My Weekly Schedule</button>
  </div>

  <div class="main">
    <div class="department-section" id="department-section">
      <h3>Department(s):</h3>
      <div class="department-list" id="department-list"></div>
    </div>
    <div class="content" id="main-content"></div>
  </div>

  <script>
    const urlParams   = new URLSearchParams(window.location.search);
    const employeeId  = parseInt(urlParams.get("id"), 10);
    let   currentUser, allEmployees, allShifts;

    const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
    const jobs = ["Waiter","Housekeeper","Receptionist","Bellboy","Baseman","Valet","Security","Chef","Bartender"];

    // Mutlak (absolute) path'lere dikkat!
    Promise.all([
      fetch("data/employees.json").then(r => r.json()),
      fetch("data/shifts.json").then(r => r.json())
    ]).then(([employees, shifts]) => {
      allEmployees = employees;
      allShifts    = shifts;
      currentUser  = allEmployees.find(e => e.id === employeeId);
      if (!currentUser) {
        console.error("Employee not found:", employeeId);
        return;
      }
      updateSidebar(currentUser);
      loadDepartments(currentUser);
    });

    function updateSidebar(user) {
      document.getElementById("profile-photo").src      = user.photo   || "/images/default.jpg";
      document.getElementById("profile-name").innerText = user.fullName;
      document.getElementById("profile-age").innerText  = user.age      || "--";
      document.getElementById("profile-primary").innerText = user.primaryJob   || "--";
      const sec = user.secondaryJob;
      document.getElementById("profile-secondary").innerText =
        sec && sec !== "null" ? sec : "-";
    }

    function loadDepartments(user) {
      const depts = new Set();
      if (user.department) {
        Array.isArray(user.department)
          ? user.department.forEach(d => depts.add(d))
          : depts.add(user.department);
      }
      if (user.primaryJob)   depts.add(user.primaryJob);
      if (user.secondaryJob) depts.add(user.secondaryJob);

      const container = document.getElementById("department-list");
      container.innerHTML = "";
      depts.forEach(dep => {
        const btn = document.createElement("button");
        btn.className = "department-button";
        btn.innerHTML = `
          <img src="/images/${dep.toLowerCase()}.png" onerror="this.src='/images/default.png'">
          <span>${dep}</span>
        `;
        btn.addEventListener("click", () => showDepartmentEmployees(dep));
        container.appendChild(btn);
      });
    }

    function showDepartmentEmployees(job) {
      // Butonların aktif/inaktif togglesı
      document.querySelectorAll(".department-button").forEach(b => {
        b.classList.toggle("active", b.innerText.trim() === job);
        b.classList.toggle("inactive", b.innerText.trim() !== job);
      });

      const peers = allEmployees.filter(e =>
        e.id !== currentUser.id &&
        (e.primaryJob === job ||
         e.secondaryJob === job ||
         (Array.isArray(e.department) && e.department.includes(job)))
      );

      const content = document.getElementById("main-content");
      content.innerHTML = `
        <h3>${job} Employees:</h3>
        <div class="employee-list">
          ${peers.map(emp => `
            <div class="employee-entry" onclick="showSchedule(${emp.id}, '${emp.fullName}', '${emp.primaryJob}', '${emp.secondaryJob}', ${emp.age})">
              <img src="${emp.photo || '/images/default.jpg'}" onerror="this.src='/images/default.jpg'">
              <div class="full">${emp.fullName}</div>
            </div>
          `).join("")}
        </div>
        <button class="weekly-btn" onclick="showDepartmentSchedule('${job}')">
          Weekly ${job} Schedule
        </button>
      `;
    }

    function showDepartmentSchedule(job) {
      const shiftsByDay = {};
      days.forEach(d => shiftsByDay[d] = { "V-1":[], "V-2":[], "V-3":[] });

      allEmployees.forEach(emp => {
        const s = allShifts[emp.id];
        if (!s) return;
        const match = emp.primaryJob === job
                   || emp.secondaryJob === job
                   || (Array.isArray(emp.department) && emp.department.includes(job));
        if (!match) return;
        ["V-1","V-2","V-3"].forEach(shift => {
          days.forEach(day => {
            const e = s[shift]?.[day];
            if (e?.job === job) {
              shiftsByDay[day][shift].push({
                name: emp.fullName,
                isSelf:      emp.id === employeeId,
                isPrimary:   emp.primaryJob === job,
                isSecondary: emp.secondaryJob === job
              });
            }
          });
        });
      });

      let tbl = `<h3>${job} Weekly Schedule</h3>
        <table>
          <thead>
            <tr><th>Shifts</th>${days.map(d=>`<th>${d}</th>`).join("")}</tr>
          </thead>
          <tbody>
            ${["V-1","V-2","V-3"].map(shift => {
              const label = shift==="V-1"?"08:00 - 16:00":shift==="V-2"?"16:00 - 00:00":"00:00 - 08:00";
              return `<tr>
                <td><strong>${label}</strong></td>
                ${days.map(day => {
                  const cell = shiftsByDay[day][shift];
                  if (!cell.length) return `<td></td>`;
                  return `<td>${cell.map(e=>{
                    const bg = e.isSelf
                             ? (e.isPrimary?"green":"yellow")
                             : "";
                    const color = e.isPrimary?"white":"black";
                    return `<span style="
                      background:${bg};
                      color:${color};
                      padding:2px 6px;
                      border-radius:4px;
                      display:block;
                    ">${e.name}</span>`;
                  }).join("")}</td>`;
                }).join("")}
              </tr>`;
            }).join("")}
          </tbody>
        </table>`;

      document.getElementById("main-content").innerHTML = tbl;
    }

    function showSchedule(id,name,primary,secondary,age) {
      document.getElementById("department-section").style.display = "none";
      // ... (isteğe göre burayı da güncelleyebilirsiniz)
    }

    function showMySchedule() {
      document.getElementById("department-section").style.display = "none";
      showSchedule(employeeId, currentUser.fullName, currentUser.primaryJob, currentUser.secondaryJob, currentUser.age);
      document.querySelectorAll(".department-button").forEach(b=>b.classList.remove("active","inactive"));
    }

    // Profil fotoğrafı tıklayınca ana ekrana dönsün:
    document.getElementById("profile-photo").addEventListener("click", () => {
      document.getElementById("department-section").style.display = "block";
      document.getElementById("main-content").innerHTML = "";
      document.querySelectorAll(".department-button").forEach(b=>b.classList.remove("active","inactive"));
    });
  </script>
</body>
</html>
